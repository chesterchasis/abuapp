<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Bienestar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un azul cielo muy suave */
        }
        .calendar-day {
            min-height: 100px;
            transition: background-color 0.3s;
        }
        .calendar-day:hover {
            background-color: #e6eef5;
        }
        .calendar-day.has-appointment {
            background-color: #cce0f5; /* Azul claro para d√≠as con citas */
            font-weight: bold;
        }
        .calendar-day.selected {
            background-color: #a3c2e0; /* Azul m√°s oscuro para el d√≠a seleccionado */
            border: 2px solid #5a7b9a;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6; /* Azul primario de Tailwind */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Gris claro de Tailwind */
            color: #374151; /* Gris oscuro */
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        /* COMENTARIO: Estilos para el vers√≠culo b√≠blico fueron simplificados o eliminados 
           ya que ahora se aplican clases de Tailwind directamente en el HTML 
           para su integraci√≥n con la imagen de fondo. */

        #loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #333;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6; /* Azul */
            animation: spin 1s ease infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* COMENTARIO: El contenedor de imagen de cabecera anterior fue eliminado.
           La nueva cabecera con imagen de fondo se maneja con clases de Tailwind directamente. */
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-indicator" class="flex items-center justify-center">
        <div class="spinner"></div>
        Cargando...
    </div>

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-xl">

        <div class="relative rounded-lg overflow-hidden mb-8 shadow-lg">
            <img src="https://raw.githubusercontent.com/chesterchasis/abuapp/refs/heads/main/cielo.png?token=GHSAT0AAAAAADDVXFE5OSRM5C4KFZR2IYBE2BXD5IA" 
                 alt="Imagen de fondo inspiradora" 
                 class="absolute inset-0 w-full h-full object-cover z-0 opacity-60" onerror="this.onerror=null; this.src='https://placehold.co/1200x400/e2e8f0/64748b?text=Imagen+No+Disponible';">
            
            <div class="relative z-10 p-6 md:p-10 text-center text-white">
                <header class="mb-6">
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-shadow-md">üóìÔ∏è Calendario de Bienestar üëµ</h1>
                    <p class="text-md sm:text-lg md:text-xl mt-2 text-shadow-sm">Organiza tus citas m√©dicas y cuida tu salud.</p>
                    <p class="text-sm mt-2 text-shadow-sm">ID de Usuario: <span id="userIdDisplay" class="font-semibold"></span></p>
                </header>

                <div id="bibleVerseCard" class="p-4 bg-black bg-opacity-40 backdrop-blur-sm rounded-xl inline-block max-w-md sm:max-w-lg md:max-w-2xl mx-auto">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-book-open text-2xl sm:text-3xl mr-3 sm:mr-4"></i>
                        <div>
                            <p id="bibleVerseText" class="text-base sm:text-lg italic">"El Se√±or es mi pastor, nada me faltar√°."</p>
                            <cite id="bibleVerseCite" class="block text-xs sm:text-sm opacity-90 mt-1">- Salmo 23:1</cite>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-col gap-8">
            <div> 
                <section id="calendar-section" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonth" class="px-3 py-2 sm:px-4 btn-secondary rounded-lg hover:bg-gray-300 text-sm sm:text-base"><i class="fas fa-chevron-left"></i> Mes Ant.</button>
                        <h2 id="currentMonthYear" class="text-xl sm:text-2xl font-semibold text-blue-700 text-center mx-2"></h2>
                        <button id="nextMonth" class="px-3 py-2 sm:px-4 btn-secondary rounded-lg hover:bg-gray-300 text-sm sm:text-base">Mes Sig. <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 border border-gray-300 rounded-lg p-2 bg-gray-50">
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Dom</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Lun</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Mar</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Mi√©</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Jue</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">Vie</div>
                        <div class="text-center font-semibold text-gray-700 py-2 text-xs sm:text-sm">S√°b</div>
                        </div>
                </section>

                <section id="selected-day-info" class="bg-blue-50 p-4 sm:p-6 rounded-lg shadow">
                    <h3 class="text-lg sm:text-xl font-semibold text-blue-700 mb-3">Informaci√≥n para el <span id="selectedDateDisplay">D√≠a Seleccionado</span></h3>
                    <div id="appointmentsForDay" class="space-y-3">
                        <p class="text-gray-600">Selecciona un d√≠a en el calendario para ver las citas.</p>
                    </div>
                     <button id="openAddAppointmentModalButton" class="mt-4 px-4 py-2 btn-primary rounded-lg w-full md:w-auto text-sm sm:text-base"><i class="fas fa-plus-circle mr-2"></i>A√±adir Cita</button>
                </section>
            </div>

            <div> 
                <section id="blood-pressure-section" class="bg-sky-50 p-4 sm:p-6 rounded-lg shadow"> 
                    <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-heartbeat mr-2"></i>Registro de Tensi√≥n Arterial</h3>
                    <button id="openAddBPModalButton" class="w-full px-4 py-2 mb-4 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm sm:text-base"><i class="fas fa-plus-circle mr-2"></i>A√±adir Toma de Tensi√≥n</button>
                    <div id="bloodPressureLog" class="space-y-3 max-h-60 overflow-y-auto mb-6"> 
                        <p class="text-gray-600">A√∫n no hay registros de tensi√≥n.</p>
                    </div>
                    <div>
                        <h4 class="text-md sm:text-lg font-semibold text-sky-700 mb-2">Evoluci√≥n de la Tensi√≥n</h4>
                        <canvas id="bpChart" class="rounded-lg"></canvas>
                        <p id="bpChartMessage" class="text-sm text-gray-500 mt-2 text-center"></p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAppointmentModal">&times;</span>
            <h3 id="appointmentModalTitle" class="text-xl sm:text-2xl font-semibold mb-4 text-blue-700">A√±adir Nueva Cita</h3>
            <form id="appointmentForm">
                <input type="hidden" id="appointmentId">
                <div class="mb-4">
                    <label for="appointmentDate" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="appointmentDate" name="appointmentDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="appointmentTime" class="block text-sm font-medium text-gray-700">Hora:</label>
                    <input type="time" id="appointmentTime" name="appointmentTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="appointmentType" class="block text-sm font-medium text-gray-700">Tipo de Cita:</label>
                    <select id="appointmentType" name="appointmentType" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="Hospital">Hospital</option>
                        <option value="M√©dico de Cabecera">M√©dico de Cabecera</option>
                        <option value="Cirujano">Especialista: Cirujano</option>
                        <option value="Endocrino">Especialista: Endocrino</option>
                        <option value="Enfermera (Tensi√≥n)">Enfermera (Tensi√≥n)</option>
                        <option value="Otro Especialista">Otro Especialista</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="appointmentNotes" class="block text-sm font-medium text-gray-700">Notas Adicionales:</label>
                    <textarea id="appointmentNotes" name="appointmentNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAppointment" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg text-sm sm:text-base">Guardar Cita</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeBPModal">&times;</span>
            <h3 class="text-xl sm:text-2xl font-semibold mb-4 text-sky-700">A√±adir Toma de Tensi√≥n</h3>
            <form id="bpForm">
                <div class="mb-4">
                    <label for="bpDate" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="bpDate" name="bpDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="bpTime" class="block text-sm font-medium text-gray-700">Hora:</label>
                    <input type="time" id="bpTime" name="bpTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="bpSystolic" class="block text-sm font-medium text-gray-700">Sist√≥lica (Alta):</label>
                        <input type="number" id="bpSystolic" name="bpSystolic" placeholder="Ej: 120" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="bpDiastolic" class="block text-sm font-medium text-gray-700">Diast√≥lica (Baja):</label>
                        <input type="number" id="bpDiastolic" name="bpDiastolic" placeholder="Ej: 80" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="bpPulse" class="block text-sm font-medium text-gray-700">Pulso (opcional):</label>
                    <input type="number" id="bpPulse" name="bpPulse" placeholder="Ej: 70" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="bpNotes" class="block text-sm font-medium text-gray-700">Notas (opcional):</label>
                    <textarea id="bpNotes" name="bpNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                     <button type="button" id="cancelBP" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm sm:text-base">Guardar Toma</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg sm:text-xl font-semibold mb-4">Confirmar Eliminaci√≥n</h3>
            <p id="confirmDeleteMessage">¬øEst√°s seguro de que quieres eliminar este elemento?</p>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancelDeleteButton" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm sm:text-base">Eliminar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Configuraci√≥n de Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'calendario-bienestar-default';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); 

        // Variables globales
        let currentYear, currentMonth;
        let selectedDate = null; 
        let userId = null;
        let appointments = []; 
        let bloodPressureReadings = []; 
        let bpChartInstance = null; 

        // Elementos del DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const appointmentsForDay = document.getElementById('appointmentsForDay');
        const bloodPressureLog = document.getElementById('bloodPressureLog');
        const bibleVerseText = document.getElementById('bibleVerseText');
        const bibleVerseCite = document.getElementById('bibleVerseCite'); 
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loading-indicator');
        const bpChartCanvas = document.getElementById('bpChart');
        const bpChartMessage = document.getElementById('bpChartMessage');


        // Modales
        const appointmentModal = document.getElementById('appointmentModal');
        const bpModal = document.getElementById('bpModal');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');

        const appointmentForm = document.getElementById('appointmentForm');
        const bpForm = document.getElementById('bpForm');

        // Botones de abrir modal
        const openAddAppointmentModalButton = document.getElementById('openAddAppointmentModalButton');
        const openAddBPModalButton = document.getElementById('openAddBPModalButton');
        
        // Botones de cerrar modal
        const closeAppointmentModalButton = document.getElementById('closeAppointmentModal');
        const closeBPModalButton = document.getElementById('closeBPModal');
        const cancelAppointmentButton = document.getElementById('cancelAppointment');
        const cancelBPButton = document.getElementById('cancelBP');

        // Botones de confirmaci√≥n de eliminaci√≥n
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let deleteFunction = null; 

        // --- Autenticaci√≥n y Carga Inicial ---
        async function initializeAppAuth() {
            showLoading("Autenticando...");
            try {
                await setPersistence(auth, browserLocalPersistence); 
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Intentando signInWithCustomToken...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("Intentando signInAnonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error en la autenticaci√≥n inicial:", error);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("Usuario autenticado:", userId);
                    await loadInitialData();
                } else {
                    userId = null;
                    userIdDisplay.textContent = "No autenticado";
                    console.log("Usuario no autenticado.");
                    hideLoading();
                }
            });
        }
        
        async function loadInitialData() {
            if (!userId) return;
            showLoading("Cargando datos...");
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth(); 
            selectedDate = today.toISOString().split('T')[0]; 

            await fetchBibleVerse();
            setupEventListeners();
            
            subscribeToAppointments();
            subscribeToBloodPressureReadings();
            hideLoading(); 
        }

        function showLoading(message = "Cargando...") {
            const loadingTextElement = loadingIndicator.querySelector('div:not(.spinner)');
            if (loadingTextElement) {
                 loadingTextElement.textContent = message;
            }
            loadingIndicator.style.display = 'flex';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // --- Calendario ---
        function renderCalendar() {
            if (!userId) return; 
            showLoading("Actualizando calendario...");
            // Limpiar calendario excepto cabeceras de d√≠as de la semana
            const dayCellsContainer = calendarGrid.querySelectorAll('.calendar-day, div:empty');
            dayCellsContainer.forEach(cell => cell.remove());


            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            currentMonthYearDisplay.textContent = `${firstDayOfMonth.toLocaleString('es-ES', { month: 'long' })} ${currentYear}`;

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day', 'p-1', 'sm:p-2', 'border', 'border-gray-200', 'text-center', 'cursor-pointer', 'rounded', 'text-xs', 'sm:text-sm');
                dayCell.textContent = day;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateStr;

                if (appointments.some(app => app.date === dateStr)) {
                    dayCell.classList.add('has-appointment');
                }
                if (dateStr === selectedDate) {
                    dayCell.classList.add('selected');
                }

                dayCell.addEventListener('click', () => {
                    selectedDate = dateStr;
                    renderCalendar(); 
                    renderAppointmentsForDay();
                    updateSelectedDateDisplay();
                });
                calendarGrid.appendChild(dayCell);
            }
            updateSelectedDateDisplay();
            renderAppointmentsForDay(); 
            hideLoading();
        }

        function updateSelectedDateDisplay() {
            if (selectedDate) {
                const dateObj = new Date(selectedDate + 'T00:00:00'); 
                selectedDateDisplay.textContent = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                selectedDateDisplay.textContent = "Ning√∫n d√≠a seleccionado";
            }
        }

        // --- Citas ---
        function subscribeToAppointments() {
            if (!userId) return;
            const appointmentsCol = collection(db, `artifacts/${appId}/users/${userId}/appointments`);
            const q = query(appointmentsCol); 

            onSnapshot(q, (snapshot) => {
                showLoading("Actualizando citas...");
                appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                appointments.sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
                    const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
                    return dateA - dateB;
                });
                console.log("Citas actualizadas desde Firestore:", appointments);
                renderCalendar(); 
                renderAppointmentsForDay(); 
                hideLoading();
            }, (error) => {
                console.error("Error al suscribirse a las citas:", error);
                hideLoading();
            });
        }

        function renderAppointmentsForDay() {
            if (!selectedDate || !userId) {
                appointmentsForDay.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">Selecciona un d√≠a en el calendario para ver las citas.</p>';
                return;
            }

            const dayAppointments = appointments.filter(app => app.date === selectedDate);
            
            if (dayAppointments.length === 0) {
                appointmentsForDay.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">No hay citas para este d√≠a.</p>';
                return;
            }

            appointmentsForDay.innerHTML = dayAppointments.map(app => `
                <div class="p-3 bg-white rounded-md shadow border-l-4 ${getAppointmentColor(app.type)}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-sm sm:text-base">${app.type}</h4>
                            <p class="text-xs sm:text-sm text-gray-600">${app.time}</p>
                            ${app.notes ? `<p class="text-xs sm:text-sm text-gray-500 mt-1">${app.notes}</p>` : ''}
                        </div>
                        <div>
                            <button class="edit-appointment text-blue-500 hover:text-blue-700 mr-2 p-1" data-id="${app.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-appointment text-red-500 hover:text-red-700 p-1" data-id="${app.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

            appointmentsForDay.querySelectorAll('.edit-appointment').forEach(button => {
                button.addEventListener('click', (e) => handleEditAppointment(e.currentTarget.dataset.id));
            });
            appointmentsForDay.querySelectorAll('.delete-appointment').forEach(button => {
                button.addEventListener('click', (e) => handleDeleteAppointment(e.currentTarget.dataset.id));
            });
        }
        
        function getAppointmentColor(type) { 
            switch (type) {
                case 'Hospital': return 'border-red-500';
                case 'M√©dico de Cabecera': return 'border-blue-500'; 
                case 'Cirujano': return 'border-purple-500';
                case 'Endocrino': return 'border-yellow-500';
                case 'Enfermera (Tensi√≥n)': return 'border-teal-500';
                case 'Otro Especialista': return 'border-indigo-500';
                default: return 'border-gray-500';
            }
        }

        async function saveAppointment(e) {
            e.preventDefault();
            if (!userId) {
                console.warn("Debes estar autenticado para guardar citas.");
                return;
            }
            showLoading("Guardando cita...");

            const id = document.getElementById('appointmentId').value;
            const appointmentData = {
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value,
            };

            try {
                const appointmentCollectionPath = `artifacts/${appId}/users/${userId}/appointments`;
                if (id) { 
                    const appointmentRef = doc(db, appointmentCollectionPath, id);
                    await updateDoc(appointmentRef, appointmentData);
                    console.log("Cita actualizada con ID: ", id);
                } else { 
                    await addDoc(collection(db, appointmentCollectionPath), appointmentData);
                    console.log("Nueva cita a√±adida");
                }
                closeModal(appointmentModal);
                appointmentForm.reset();
            } catch (error) {
                console.error("Error guardando cita: ", error);
            } finally {
                hideLoading();
            }
        }

        function handleEditAppointment(id) {
            const appointment = appointments.find(app => app.id === id);
            if (appointment) {
                document.getElementById('appointmentId').value = appointment.id;
                document.getElementById('appointmentDate').value = appointment.date;
                document.getElementById('appointmentTime').value = appointment.time;
                document.getElementById('appointmentType').value = appointment.type;
                document.getElementById('appointmentNotes').value = appointment.notes || '';
                document.getElementById('appointmentModalTitle').textContent = "Editar Cita";
                openModal(appointmentModal);
            }
        }

        function handleDeleteAppointment(id) {
            openConfirmDeleteModal("¬øEst√°s seguro de que quieres eliminar esta cita?", async () => {
                if (!userId) return;
                showLoading("Eliminando cita...");
                try {
                    const appointmentRef = doc(db, `artifacts/${appId}/users/${userId}/appointments`, id);
                    await deleteDoc(appointmentRef);
                    console.log("Cita eliminada con ID: ", id);
                } catch (error) {
                    console.error("Error eliminando cita: ", error);
                } finally {
                    hideLoading();
                }
            });
        }

        // --- Registro de Tensi√≥n Arterial y Gr√°fico ---
        function subscribeToBloodPressureReadings() {
            if (!userId) return;
            const bpCol = collection(db, `artifacts/${appId}/users/${userId}/bloodPressureReadings`);
            const q = query(bpCol); 

            onSnapshot(q, (snapshot) => {
                showLoading("Actualizando lecturas de tensi√≥n...");
                bloodPressureReadings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                bloodPressureReadings.sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time || '00:00'}`);
                    const dateB = new Date(`${b.date}T${b.time || '00:00'}`);
                    return dateA - dateB; 
                });
                console.log("Lecturas de tensi√≥n actualizadas:", bloodPressureReadings);
                renderBloodPressureLog();
                renderBPChart(); 
                hideLoading();
            }, (error) => {
                console.error("Error al suscribirse a las lecturas de tensi√≥n:", error);
                hideLoading();
            });
        }

        function renderBloodPressureLog() {
            if (!userId) {
                 bloodPressureLog.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">Debes estar autenticado para ver el registro.</p>';
                return;
            }
            const reversedReadings = [...bloodPressureReadings].reverse(); 

            if (reversedReadings.length === 0) {
                bloodPressureLog.innerHTML = '<p class="text-gray-600 text-sm sm:text-base">A√∫n no hay registros de tensi√≥n.</p>';
                return;
            }

            bloodPressureLog.innerHTML = reversedReadings.map(bp => {
                const bpDate = new Date(bp.date + 'T' + (bp.time || '00:00:00')); 
                return `
                <div class="p-3 bg-white rounded-md shadow border-l-4 border-sky-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-sm sm:text-base">${bp.systolic} / ${bp.diastolic} mmHg ${bp.pulse ? `(${bp.pulse} ppm)` : ''}</p>
                            <p class="text-xs sm:text-sm text-gray-600">${bpDate.toLocaleDateString('es-ES')} ${bp.time || ''}</p>
                            ${bp.notes ? `<p class="text-xs sm:text-sm text-gray-500 mt-1">${bp.notes}</p>` : ''}
                        </div>
                        <button class="delete-bp text-red-500 hover:text-red-700 p-1" data-id="${bp.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `}).join('');
            
            bloodPressureLog.querySelectorAll('.delete-bp').forEach(button => {
                button.addEventListener('click', (e) => handleDeleteBPReading(e.currentTarget.dataset.id));
            });
        }

        function renderBPChart() {
            if (!userId) return;
            const ctx = bpChartCanvas.getContext('2d');

            if (bpChartInstance) {
                bpChartInstance.destroy(); 
            }

            if (bloodPressureReadings.length === 0) {
                bpChartMessage.textContent = "No hay suficientes datos para mostrar el gr√°fico.";
                bpChartCanvas.style.display = 'none'; 
                return;
            }
            bpChartCanvas.style.display = 'block'; 
            bpChartMessage.textContent = "";


            const labels = bloodPressureReadings.map(bp => {
                const date = new Date(bp.date + 'T' + (bp.time || "00:00"));
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            });
            const systolicData = bloodPressureReadings.map(bp => bp.systolic);
            const diastolicData = bloodPressureReadings.map(bp => bp.diastolic);

            bpChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sist√≥lica (Alta)',
                            data: systolicData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)', 
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Diast√≥lica (Baja)',
                            data: diastolicData,
                            backgroundColor: 'rgba(14, 165, 233, 0.7)', 
                            borderColor: 'rgba(14, 165, 233, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, 
                    scales: {
                        y: {
                            beginAtZero: false, 
                            title: {
                                display: true,
                                text: 'Presi√≥n (mmHg)'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Fecha de Toma'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }


        async function saveBPReading(e) {
            e.preventDefault();
            if (!userId) {
                console.warn("Debes estar autenticado para guardar lecturas.");
                return;
            }
            showLoading("Guardando lectura de tensi√≥n...");

            const bpData = {
                date: document.getElementById('bpDate').value,
                time: document.getElementById('bpTime').value,
                systolic: parseInt(document.getElementById('bpSystolic').value),
                diastolic: parseInt(document.getElementById('bpDiastolic').value),
                pulse: document.getElementById('bpPulse').value ? parseInt(document.getElementById('bpPulse').value) : null,
                notes: document.getElementById('bpNotes').value,
            };

            try {
                const bpCollectionPath = `artifacts/${appId}/users/${userId}/bloodPressureReadings`;
                await addDoc(collection(db, bpCollectionPath), bpData);
                console.log("Nueva lectura de tensi√≥n a√±adida");
                closeModal(bpModal);
                bpForm.reset();
            } catch (error) {
                console.error("Error guardando lectura de tensi√≥n: ", error);
            } finally {
                hideLoading();
            }
        }

        function handleDeleteBPReading(id) {
             openConfirmDeleteModal("¬øEst√°s seguro de que quieres eliminar esta toma de tensi√≥n?", async () => {
                if (!userId) return;
                showLoading("Eliminando lectura...");
                try {
                    const bpRef = doc(db, `artifacts/${appId}/users/${userId}/bloodPressureReadings`, id);
                    await deleteDoc(bpRef);
                    console.log("Lectura de tensi√≥n eliminada con ID: ", id);
                } catch (error) {
                    console.error("Error eliminando lectura de tensi√≥n: ", error);
                } finally {
                    hideLoading();
                }
            });
        }

        // --- Vers√≠culo B√≠blico ---
        async function fetchBibleVerse() {
            showLoading("Cargando vers√≠culo...");
            bibleVerseText.textContent = "Cargando...";
            bibleVerseCite.textContent = "";
            const prompt = "Proporciona un √∫nico vers√≠culo b√≠blico edificante y corto en espa√±ol, seguido √∫nicamente por su cita entre par√©ntesis (Libro Cap√≠tulo:Vers√≠culo). No incluyas ninguna frase introductoria como 'Claro, aqu√≠ tienes...' o similar. Ejemplo: Porque de tal manera am√≥ Dios al mundo... (Juan 3:16)";
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let fullText = result.candidates[0].content.parts[0].text;
                    
                    const match = fullText.match(/(.*)\s*\(([^)]+)\)$/); 
                    if (match && match[1] && match[2]) {
                        bibleVerseText.textContent = match[1].trim();
                        bibleVerseCite.textContent = `(${match[2].trim()})`;
                    } else {
                        bibleVerseText.textContent = fullText;
                        bibleVerseCite.textContent = ""; 
                        console.warn("No se pudo extraer la cita del vers√≠culo:", fullText);
                    }
                } else {
                    bibleVerseText.textContent = "No se pudo cargar el vers√≠culo en este momento.";
                    bibleVerseCite.textContent = "";
                    console.error("Respuesta inesperada de la API de Gemini:", result);
                }
            } catch (error) {
                console.error("Error al obtener el vers√≠culo b√≠blico:", error);
                bibleVerseText.textContent = "No se pudo cargar el vers√≠culo. Intenta m√°s tarde.";
                bibleVerseCite.textContent = "";
            } finally {
                hideLoading();
            }
        }

        // --- Modales ---
        function openModal(modalElement) {
            if (selectedDate) {
                if (modalElement === appointmentModal && !document.getElementById('appointmentId').value) { 
                    document.getElementById('appointmentDate').value = selectedDate;
                }
                if (modalElement === bpModal) {
                     document.getElementById('bpDate').value = selectedDate;
                     const now = new Date();
                     document.getElementById('bpTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                }
            }
            modalElement.style.display = "block";
        }

        function closeModal(modalElement) {
            modalElement.style.display = "none";
            if (modalElement === appointmentModal) {
                appointmentForm.reset();
                document.getElementById('appointmentId').value = ''; 
                document.getElementById('appointmentModalTitle').textContent = "A√±adir Nueva Cita";
            }
            if (modalElement === bpModal) {
                bpForm.reset();
            }
        }
        
        function openConfirmDeleteModal(message, onConfirm) {
            document.getElementById('confirmDeleteMessage').textContent = message;
            deleteFunction = onConfirm; 
            openModal(confirmDeleteModal);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            prevMonthButton.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthButton.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });


            openAddAppointmentModalButton.addEventListener('click', () => {
                 document.getElementById('appointmentModalTitle').textContent = "A√±adir Nueva Cita";
                 document.getElementById('appointmentId').value = ''; 
                 appointmentForm.reset(); 
                 if(selectedDate) document.getElementById('appointmentDate').value = selectedDate; 
                 const now = new Date();
                 document.getElementById('appointmentTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                 openModal(appointmentModal);
            });
            openAddBPModalButton.addEventListener('click', () => {
                bpForm.reset();
                if(selectedDate) document.getElementById('bpDate').value = selectedDate;
                const now = new Date();
                document.getElementById('bpTime').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                openModal(bpModal);
            });

            closeAppointmentModalButton.addEventListener('click', () => closeModal(appointmentModal));
            cancelAppointmentButton.addEventListener('click', () => closeModal(appointmentModal));
            closeBPModalButton.addEventListener('click', () => closeModal(bpModal));
            cancelBPButton.addEventListener('click', () => closeModal(bpModal));
            
            cancelDeleteButton.addEventListener('click', () => {
                closeModal(confirmDeleteModal);
                deleteFunction = null; 
            });
            confirmDeleteButton.addEventListener('click', () => {
                if (deleteFunction) {
                    deleteFunction();
                }
                closeModal(confirmDeleteModal);
                deleteFunction = null;
            });

            window.onclick = function(event) {
                if (event.target == appointmentModal) {
                    closeModal(appointmentModal);
                }
                if (event.target == bpModal) {
                    closeModal(bpModal);
                }
                if (event.target == confirmDeleteModal) {
                    closeModal(confirmDeleteModal);
                    deleteFunction = null;
                }
            }

            appointmentForm.addEventListener('submit', saveAppointment);
            bpForm.addEventListener('submit', saveBPReading);
        }

        // Iniciar la aplicaci√≥n
        initializeAppAuth();

    </script>
</body>
</html>
