<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Bienestar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo de p√°gina con imagen y degradado superpuesto */
            background-image: linear-gradient(to bottom, rgba(173, 216, 230, 0.4), rgba(224, 231, 255, 0.7)), url('https://raw.githubusercontent.com/chesterchasis/abuapp/refs/heads/main/cielo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Fondo fijo al hacer scroll */
            color: #1f2937; /* Tailwind gray-800 para mejor contraste */
            margin: 0;
            min-height: 100vh;
        }

        /* Estilos para el indicador de carga */
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #007BFF; /* Azul primario */
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Estilos para los Modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Un poco m√°s oscuro para mejor contraste del modal */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #b0bec5; /* Tailwind blue-gray-300 */
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #757575; /* Gris m√°s oscuro */
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: #212121; /* Negro */
            text-decoration: none;
            cursor: pointer;
        }

        /* Estilos para el Calendario */
        .calendar-day {
            position: relative;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }

        #calendarGrid .calendar-day.selected {
            background-color: #1d4ed8; /* Tailwind blue-700 (m√°s oscuro para selecci√≥n) */
            color: white !important;
            font-weight: bold;
            transform: scale(1.05); /* Peque√±o efecto al seleccionar */
        }

        #calendarGrid .calendar-day.has-appointment::after {
            content: '';
            position: absolute;
            bottom: 4px; /* Ajustar posici√≥n vertical del punto */
            left: 50%;
            transform: translateX(-50%);
            width: 7px; /* Punto un poco m√°s grande */
            height: 7px;
            background-color: #c53030; /* Tailwind red-700 (m√°s oscuro) */
            border-radius: 50%;
            border: 1px solid white; /* Borde blanco para el punto */
        }

        #calendarGrid .calendar-day.today {
            font-weight: bold;
            color: #0ea5e9; /* Tailwind sky-500 */
            border: 1px solid #0ea5e9; /* Borde para el d√≠a de hoy */
        }
        #calendarGrid .calendar-day.today:not(.selected):hover {
            background-color: #e0f2fe; /* Tailwind sky-100 */
        }

        /* Estilo para fines de semana */
        #calendarGrid .calendar-day.weekend-day:not(.selected) {
            background-color: #f0f9ff; /* Tailwind sky-50 (muy claro) */
            color: #374151; /* Tailwind gray-700 */
        }
        #calendarGrid .calendar-day.weekend-day:not(.selected):hover {
            background-color: #e0f2fe; /* Tailwind sky-100 */
        }


        .text-shadow-md {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .text-shadow-sm {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background-color: #007BFF;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-indicator" class="hidden"> <div class="spinner"></div>
        <div class="text-lg font-semibold text-gray-700">Cargando...</div>
    </div>

    <div class="max-w-6xl mx-auto bg-white/90 backdrop-blur-sm p-4 sm:p-6 rounded-xl shadow-2xl">

        <div class="relative text-center mb-8 pt-8 pb-4">
             <header class="mb-6">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800 text-shadow-sm">üóìÔ∏è Calendario de Bienestar üëµ</h1>
                <p class="text-md sm:text-lg md:text-xl mt-2 text-slate-700 text-shadow-sm">Organiza tus citas m√©dicas y cuida tu salud.</p>
                <p class="text-sm mt-2 text-slate-600">ID de Usuario: <span id="userIdDisplay" class="font-semibold">Cargando...</span></p>
            </header>

            <div id="bibleVerseCard" class="p-4 bg-black/60 backdrop-blur-md rounded-xl inline-block max-w-md sm:max-w-lg md:max-w-2xl mx-auto text-white">
                <div class="flex items-center justify-center">
                    <i class="fas fa-book-open text-2xl sm:text-3xl mr-3 sm:mr-4"></i>
                    <div>
                        <p id="bibleVerseText" class="text-base sm:text-lg italic">"El Se√±or es mi pastor, nada me faltar√°."</p>
                        <cite id="bibleVerseCite" class="block text-xs sm:text-sm opacity-90 mt-1">- Salmo 23:1</cite>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            <div>
                <section id="calendar-section" class="mb-8 p-4 sm:p-6 bg-slate-50/80 backdrop-blur-sm rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <button id="prevMonth" class="px-3 py-2 sm:px-4 btn-secondary rounded-lg hover:bg-slate-300 text-sm sm:text-base shadow hover:shadow-md transition-all"><i class="fas fa-chevron-left"></i> Mes Ant.</button>
                        <h2 id="currentMonthYear" class="text-xl sm:text-2xl font-semibold text-blue-700 text-center mx-2"></h2>
                        <button id="nextMonth" class="px-3 py-2 sm:px-4 btn-secondary rounded-lg hover:bg-slate-300 text-sm sm:text-base shadow hover:shadow-md transition-all">Mes Sig. <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarGridHeader" class="grid grid-cols-7 gap-1 border-b border-slate-300 pb-2 mb-2">
                        <div class="text-center font-semibold text-slate-700 py-2 text-xs sm:text-sm">Lun</div>
                        <div class="text-center font-semibold text-slate-700 py-2 text-xs sm:text-sm">Mar</div>
                        <div class="text-center font-semibold text-slate-700 py-2 text-xs sm:text-sm">Mi√©</div>
                        <div class="text-center font-semibold text-slate-700 py-2 text-xs sm:text-sm">Jue</div>
                        <div class="text-center font-semibold text-slate-700 py-2 text-xs sm:text-sm">Vie</div>
                        <div class="text-center font-semibold text-sky-600 py-2 text-xs sm:text-sm">S√°b</div> 
                        <div class="text-center font-semibold text-sky-600 py-2 text-xs sm:text-sm">Dom</div> 
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1.5 p-1">
                        
                    </div>
                </section>

                <section id="selected-day-info" class="bg-blue-50/80 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg sm:text-xl font-semibold text-blue-700 mb-3">Informaci√≥n para el <span id="selectedDateDisplay">D√≠a Seleccionado</span></h3>
                    <div id="appointmentsForDay" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <p class="text-slate-600">Selecciona un d√≠a en el calendario para ver las citas.</p>
                    </div>
                     <button id="openAddAppointmentModalButton" class="mt-4 px-4 py-2 btn-primary rounded-lg w-full md:w-auto text-sm sm:text-base shadow hover:shadow-md transition-all"><i class="fas fa-plus-circle mr-2"></i>A√±adir Cita</button>
                </section>
            </div>

            <div>
                <section id="blood-pressure-section" class="bg-sky-50/80 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-heartbeat mr-2"></i>Registro de Tensi√≥n Arterial</h3>
                    <button id="openAddBPModalButton" class="w-full px-4 py-2 mb-4 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm sm:text-base shadow hover:shadow-md transition-all"><i class="fas fa-plus-circle mr-2"></i>A√±adir Toma de Tensi√≥n</button>
                    <div id="bloodPressureLog" class="space-y-3 max-h-60 overflow-y-auto mb-6 pr-2">
                        <p class="text-slate-600">A√∫n no hay registros de tensi√≥n.</p>
                    </div>
                    <div>
                        <h4 class="text-md sm:text-lg font-semibold text-sky-700 mb-2">Evoluci√≥n de la Tensi√≥n</h4>
                        <div class="relative h-64 sm:h-72 bg-white/50 p-2 rounded-md">
                            <canvas id="bpChart" class="rounded-lg"></canvas>
                        </div>
                        <p id="bpChartMessage" class="text-sm text-slate-500 mt-2 text-center"></p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAppointmentModal">&times;</span>
            <h3 id="appointmentModalTitle" class="text-xl sm:text-2xl font-semibold mb-4 text-blue-700">A√±adir Nueva Cita</h3>
            <form id="appointmentForm">
                <input type="hidden" id="appointmentId">
                <div class="mb-4">
                    <label for="appointmentDate" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="appointmentDate" name="appointmentDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="appointmentTime" class="block text-sm font-medium text-gray-700">Hora:</label>
                    <input type="time" id="appointmentTime" name="appointmentTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="appointmentType" class="block text-sm font-medium text-gray-700">Tipo de Cita:</label>
                    <select id="appointmentType" name="appointmentType" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        <option value="Hospital">Hospital</option>
                        <option value="M√©dico de Cabecera">M√©dico de Cabecera</option>
                        <option value="Cirujano">Especialista: Cirujano</option>
                        <option value="Endocrino">Especialista: Endocrino</option>
                        <option value="Enfermera (Tensi√≥n)">Enfermera (Tensi√≥n)</option>
                        <option value="Otro Especialista">Otro Especialista</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="appointmentNotes" class="block text-sm font-medium text-gray-700">Notas Adicionales:</label>
                    <textarea id="appointmentNotes" name="appointmentNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAppointment" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg text-sm sm:text-base">Guardar Cita</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bpModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeBPModal">&times;</span>
            <h3 class="text-xl sm:text-2xl font-semibold mb-4 text-sky-700">A√±adir Toma de Tensi√≥n</h3>
            <form id="bpForm">
                <div class="mb-4">
                    <label for="bpDate" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="bpDate" name="bpDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="bpTime" class="block text-sm font-medium text-gray-700">Hora:</label>
                    <input type="time" id="bpTime" name="bpTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="bpSystolic" class="block text-sm font-medium text-gray-700">Sist√≥lica (Alta):</label>
                        <input type="number" id="bpSystolic" name="bpSystolic" placeholder="Ej: 120" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="bpDiastolic" class="block text-sm font-medium text-gray-700">Diast√≥lica (Baja):</label>
                        <input type="number" id="bpDiastolic" name="bpDiastolic" placeholder="Ej: 80" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="bpPulse" class="block text-sm font-medium text-gray-700">Pulso (opcional):</label>
                    <input type="number" id="bpPulse" name="bpPulse" placeholder="Ej: 70" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="bpNotes" class="block text-sm font-medium text-gray-700">Notas (opcional):</label>
                    <textarea id="bpNotes" name="bpNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                     <button type="button" id="cancelBP" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 text-sm sm:text-base">Guardar Toma</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg sm:text-xl font-semibold mb-4">Confirmar Eliminaci√≥n</h3>
            <p id="confirmDeleteMessage">¬øEst√°s seguro de que quieres eliminar este elemento?</p>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancelDeleteButton" class="px-4 py-2 btn-secondary rounded-lg text-sm sm:text-base">Cancelar</button>
                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm sm:text-base">Eliminar</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Configuraci√≥n de Firebase
        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = firebaseConfigFromGlobal || {
            apiKey: "AIzaSyCB_GtOMByc22KD__hd0dp1Y1XijFehCtE",
            authDomain: "abuapp-ed946.firebaseapp.com",
            databaseURL: "https://abuapp-ed946-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "abuapp-ed946",
            storageBucket: "abuapp-ed946.firebasestorage.app",
            messagingSenderId: "144970687143",
            appId: "1:144970687143:web:35ad5f75b89af8d2c4f182"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'calendario-bienestar-default';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); 

        // Variables globales
        let currentYear, currentMonth;
        let selectedDate = null;
        let userId = null;
        let appointments = [];
        let bloodPressureReadings = [];
        let bpChartInstance = null;
        let unsubscribeAppointments = () => {}; 
        let unsubscribeBPReadings = () => {};   

        // Elementos del DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const appointmentsForDay = document.getElementById('appointmentsForDay');
        const bloodPressureLog = document.getElementById('bloodPressureLog');
        const bibleVerseText = document.getElementById('bibleVerseText');
        const bibleVerseCite = document.getElementById('bibleVerseCite');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loading-indicator');
        const bpChartCanvas = document.getElementById('bpChart').getContext('2d'); 
        const bpChartMessage = document.getElementById('bpChartMessage');

        // Modales y Formularios
        const appointmentModal = document.getElementById('appointmentModal');
        const bpModal = document.getElementById('bpModal');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const appointmentForm = document.getElementById('appointmentForm');
        const bpForm = document.getElementById('bpForm');

        // Botones
        const openAddAppointmentModalButton = document.getElementById('openAddAppointmentModalButton');
        const openAddBPModalButton = document.getElementById('openAddBPModalButton');
        const closeAppointmentModalButton = document.getElementById('closeAppointmentModal');
        const closeBPModalButton = document.getElementById('closeBPModal');
        const cancelAppointmentButton = document.getElementById('cancelAppointment');
        const cancelBPButton = document.getElementById('cancelBP');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let deleteFunction = null; 

        // --- Utilidades ---
        function showLoading(message = "Cargando...") {
            const loadingTextElement = loadingIndicator.querySelector('div:not(.spinner)');
            if (loadingTextElement) loadingTextElement.textContent = message;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.style.display = 'flex';
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            loadingIndicator.style.display = 'none';
        }

        function openModal(modalElement) { modalElement.style.display = 'flex'; }
        function closeModal(modalElement) { modalElement.style.display = 'none'; }

        function openConfirmDeleteModal(message, callback) {
            document.getElementById('confirmDeleteMessage').textContent = message;
            deleteFunction = callback;
            openModal(confirmDeleteModal);
        }

        // --- Autenticaci√≥n y Carga Inicial ---
        async function initializeAppAuth() {
            showLoading("Autenticando...");
            try {
                await setPersistence(auth, browserLocalPersistence);
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) await signInWithCustomToken(auth, authToken);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error("Error en autenticaci√≥n inicial:", error);
                if (error.code === 'auth/invalid-custom-token' || error.code === 'auth/custom-token-mismatch') {
                    try { await signInAnonymously(auth); } catch (e) { console.error("Error en fallback an√≥nimo:", e); }
                }
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    await loadInitialData();
                } else {
                    userId = null;
                    userIdDisplay.textContent = "No autenticado";
                    appointments = []; bloodPressureReadings = [];
                    renderCalendar(); renderAppointmentsForDay(); renderBloodPressureLog(); renderBPChart();
                    hideLoading();
                }
            });
        }

        async function loadInitialData() {
            if (!userId) { hideLoading(); return; }
            showLoading("Cargando datos...");
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            selectedDate = today.toISOString().split('T')[0];
            await fetchBibleVerse();
            setupEventListeners();
            unsubscribeAppointments(); unsubscribeBPReadings();
            subscribeToAppointments(); subscribeToBloodPressureReadings();
        }

        // --- Vers√≠culo B√≠blico ---
        async function fetchBibleVerse() {
            const verses = [ /* ... lista de vers√≠culos ... */ ]; // Mantener lista por si falla API
            try {
                const prompt = "Dame un vers√≠culo b√≠blico inspirador corto en espa√±ol con su cita.";
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const text = result.candidates[0].content.parts[0].text;
                    const match = text.match(/(.*) - (.*)/) || text.match(/(.*)\((.*)\)/);
                    if (match?.[2]) {
                        bibleVerseText.textContent = `"${match[1].trim()}"`;
                        bibleVerseCite.textContent = `- ${match[2].trim()}`;
                    } else {
                        const lastSpace = text.lastIndexOf(' ');
                        bibleVerseText.textContent = `"${lastSpace > 0 ? text.substring(0, lastSpace) : text}"`;
                        bibleVerseCite.textContent = lastSpace > 0 ? `- ${text.substring(lastSpace + 1)}` : "";
                    }
                } else throw new Error("Respuesta API inesperada.");
            } catch (error) {
                console.warn("Error API vers√≠culo, usando local:", error);
                const randomVerse = verses[Math.floor(Math.random() * verses.length)] || { text: "Conf√≠a en el Se√±or.", cite: "Proverbios 3:5" };
                bibleVerseText.textContent = `"${randomVerse.text}"`;
                bibleVerseCite.textContent = `- ${randomVerse.cite}`;
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            prevMonthButton.addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); });
            nextMonthButton.addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); });
            openAddAppointmentModalButton.addEventListener('click', () => {
                appointmentForm.reset(); appointmentId.value = '';
                appointmentModalTitle.textContent = "A√±adir Nueva Cita";
                appointmentDate.value = selectedDate || new Date().toISOString().split('T')[0];
                appointmentTime.value = new Date().toTimeString().substring(0,5);
                openModal(appointmentModal);
            });
            openAddBPModalButton.addEventListener('click', () => {
                bpForm.reset();
                bpDate.value = new Date().toISOString().split('T')[0];
                bpTime.value = new Date().toTimeString().substring(0,5);
                openModal(bpModal);
            });
            closeAppointmentModalButton.addEventListener('click', () => closeModal(appointmentModal));
            closeBPModalButton.addEventListener('click', () => closeModal(bpModal));
            cancelAppointmentButton.addEventListener('click', () => closeModal(appointmentModal));
            cancelBPButton.addEventListener('click', () => closeModal(bpModal));
            appointmentForm.addEventListener('submit', saveAppointment);
            bpForm.addEventListener('submit', saveBPReading);
            cancelDeleteButton.addEventListener('click', () => closeModal(confirmDeleteModal));
            confirmDeleteButton.addEventListener('click', () => { if (deleteFunction) deleteFunction(); closeModal(confirmDeleteModal); });
        }

        // --- Calendario ---
        function renderCalendar() {
            if (!userId) return;
            showLoading("Actualizando calendario...");
            calendarGrid.innerHTML = '';
            const todayObj = new Date();
            const todayDateStr = todayObj.toISOString().split('T')[0];
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            // Ajuste para que Lunes sea 0, Martes 1, ..., Domingo 6
            let startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

            currentMonthYearDisplay.textContent = `${firstDayOfMonth.toLocaleString('es-ES', { month: 'long' })} ${currentYear}`;

            for (let i = 0; i < startDayOfWeek; i++) { calendarGrid.appendChild(document.createElement('div')); }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDateObj = new Date(dateStr + "T00:00:00"); // Para obtener el d√≠a de la semana correctamente
                const dayOfWeek = (currentDateObj.getDay() + 6) % 7; // Lunes = 0, ..., Domingo = 6

                let cellClasses = ['calendar-day', 'relative', 'p-2', 'h-16', 'sm:h-20', 'text-center', 'cursor-pointer', 'rounded-lg', 'text-sm', 'flex', 'items-center', 'justify-center'];
                
                // Estilos base (no seleccionado, no hoy, no finde)
                cellClasses.push('bg-white', 'text-gray-700', 'hover:bg-blue-100');

                dayCell.textContent = day;
                dayCell.dataset.date = dateStr;
                
                // Aplicar clases base
                dayCell.className = cellClasses.join(' ');


                if (dayOfWeek === 5 || dayOfWeek === 6) { // S√°bado (5) o Domingo (6)
                    dayCell.classList.add('weekend-day');
                     // Quitar hover normal si es finde y no est√° seleccionado
                    if (dateStr !== selectedDate) {
                        dayCell.classList.remove('hover:bg-blue-100');
                    }
                }
                
                if (dateStr === todayDateStr) {
                    dayCell.classList.add('today');
                    if (dateStr !== selectedDate) { // Si es hoy pero no est√° seleccionado
                        dayCell.classList.remove('hover:bg-blue-100'); // Quitar hover normal
                        // El hover de 'today' (si no es finde) se maneja en CSS
                        if(dayCell.classList.contains('weekend-day')){
                             // El hover de 'weekend-day' ya est√° definido y es correcto
                        } else {
                            // Si es 'today' pero no 'weekend-day' y no 'selected'
                            // El hover se define en CSS: #calendarGrid .calendar-day.today:not(.selected):hover
                        }
                    }
                }

                if (appointments.some(app => app.date === dateStr)) {
                    dayCell.classList.add('has-appointment');
                }

                if (dateStr === selectedDate) {
                    // Limpiar clases de fondo/texto conflictivas antes de a√±adir 'selected'
                    dayCell.classList.remove('bg-white', 'text-gray-700', 'hover:bg-blue-100', 'weekend-day', 'today');
                    dayCell.classList.add('selected');
                }
                
                dayCell.addEventListener('click', () => {
                    selectedDate = dateStr;
                    renderCalendar(); renderAppointmentsForDay(); updateSelectedDateDisplay();
                });
                calendarGrid.appendChild(dayCell);
            }
            updateSelectedDateDisplay();
            renderAppointmentsForDay();
            hideLoading();
        }

        function updateSelectedDateDisplay() {
            if (selectedDate) {
                const dateObj = new Date(selectedDate + 'T00:00:00');
                selectedDateDisplay.textContent = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                selectedDateDisplay.textContent = "Ning√∫n d√≠a seleccionado";
            }
        }

        // --- Citas ---
        function subscribeToAppointments() {
            if (!userId) return;
            const appointmentsCol = collection(db, `artifacts/${appId}/users/${userId}/appointments`);
            const q = query(appointmentsCol);
            unsubscribeAppointments = onSnapshot(q, (snapshot) => {
                showLoading("Actualizando citas...");
                appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                appointments.sort((a, b) => new Date(`${a.date}T${a.time||'00:00'}`) - new Date(`${b.date}T${b.time||'00:00'}`));
                renderCalendar(); renderAppointmentsForDay();
                hideLoading();
            }, (error) => { console.error("Error suscripci√≥n citas:", error); hideLoading(); });
        }

        function renderAppointmentsForDay() {
            if (!selectedDate || !userId) {
                appointmentsForDay.innerHTML = '<p class="text-slate-600">Selecciona un d√≠a.</p>'; return;
            }
            const dayApps = appointments.filter(app => app.date === selectedDate);
            if (dayApps.length === 0) {
                appointmentsForDay.innerHTML = '<p class="text-slate-600">No hay citas este d√≠a.</p>'; return;
            }
            appointmentsForDay.innerHTML = dayApps.map(app =>
                <div class="p-3 bg-white rounded-md shadow border-l-4 ${getAppointmentColor(app.type)}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-sm">${app.type}</h4>
                            <p class="text-xs text-gray-600">${app.time||'Sin hora'}</p>
                            ${app.notes ? `<p class="text-xs text-gray-500 mt-1">${app.notes}</p>` : ''}
                        </div>
                        <div class="flex-shrink-0">
                            <button class="edit-appointment text-blue-500 hov:text-blue-700 mr-2 p-1" data-id="${app.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-appointment text-red-500 hov:text-red-700 p-1" data-id="${app.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>).join('');
            appointmentsForDay.querySelectorAll('.edit-appointment').forEach(b => b.addEventListener('click', (e) => handleEditAppointment(e.currentTarget.dataset.id)));
            appointmentsForDay.querySelectorAll('.delete-appointment').forEach(b => b.addEventListener('click', (e) => handleDeleteAppointment(e.currentTarget.dataset.id)));
        }

        function getAppointmentColor(type) { 
            switch (type) {
                case 'Hospital': return 'border-red-500';
                case 'M√©dico de Cabecera': return 'border-blue-500';
                case 'Cirujano': return 'border-purple-500';
                case 'Endocrino': return 'border-yellow-500';
                case 'Enfermera (Tensi√≥n)': return 'border-teal-500';
                case 'Otro Especialista': return 'border-indigo-500';
                default: return 'border-gray-500';
            }
        }

        async function saveAppointment(e) {
            e.preventDefault(); if (!userId) { console.warn("Autenticaci√≥n requerida."); return; }
            showLoading("Guardando cita...");
            const id = appointmentId.value;
            const data = { date: appointmentDate.value, time: appointmentTime.value, type: appointmentType.value, notes: appointmentNotes.value };
            try {
                const path = `artifacts/${appId}/users/${userId}/appointments`;
                if (id) await updateDoc(doc(db, path, id), data);
                else await addDoc(collection(db, path), data);
                closeModal(appointmentModal); appointmentForm.reset();
            } catch (err) { console.error("Error guardando cita:", err); } finally { hideLoading(); }
        }

        function handleEditAppointment(id) {
            const app = appointments.find(a => a.id === id);
            if (app) {
                appointmentId.value = app.id; appointmentDate.value = app.date; appointmentTime.value = app.time;
                appointmentType.value = app.type; appointmentNotes.value = app.notes || '';
                appointmentModalTitle.textContent = "Editar Cita"; openModal(appointmentModal);
            }
        }

        function handleDeleteAppointment(id) {
            openConfirmDeleteModal("¬øEliminar esta cita?", async () => {
                if (!userId) return; showLoading("Eliminando cita...");
                try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/appointments`, id)); }
                catch (err) { console.error("Error eliminando cita:", err); } finally { hideLoading(); }
            });
        }

        // --- Tensi√≥n Arterial ---
        function subscribeToBloodPressureReadings() {
            if (!userId) return;
            const bpCol = collection(db, `artifacts/${appId}/users/${userId}/bloodPressureReadings`);
            const q = query(bpCol);
            unsubscribeBPReadings = onSnapshot(q, (snapshot) => {
                showLoading("Actualizando tensi√≥n...");
                bloodPressureReadings = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                bloodPressureReadings.sort((a,b) => new Date(`${a.date}T${a.time||'00:00'}`) - new Date(`${b.date}T${b.time||'00:00'}`));
                renderBloodPressureLog(); renderBPChart();
                hideLoading();
            }, (error) => { console.error("Error suscripci√≥n tensi√≥n:", error); hideLoading(); });
        }
        /* ... misma funci√≥n, ajustada para nueva est√©tica si es necesario ... */
        function renderBloodPressureLog() {
            if (!userId) { bloodPressureLog.innerHTML = '<p class="text-slate-600">Autenticaci√≥n requerida.</p>'; return; }
            const reversed = [...bloodPressureReadings].reverse();
            if (reversed.length === 0) { bloodPressureLog.innerHTML = '<p class="text-slate-600">No hay registros.</p>'; return; }
            bloodPressureLog.innerHTML = reversed.map(r => `
                <div class="p-3 bg-white rounded-md shadow border-l-4 border-sky-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-sm">${new Date(r.date+'T'+(r.time||'00:00')).toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'numeric'})} ${r.time?'- '+r.time:''}</p>
                            <p class="text-md text-gray-800">Sist: <b class="text-black">${r.systolic}</b>, Diast: <b class="text-black">${r.diastolic}</b> mmHg ${r.pulse?`, Pulso: <b class="text-black">${r.pulse}</b> bpm`:''}</p>
                            ${r.notes?`<p class="text-xs text-gray-500 mt-1">Notas: ${r.notes}</p>`:''}
                        </div>
                        <div class="flex-shrink-0">
                            <button class="delete-bp text-red-500 hov:text-red-700 p-1" data-id="${r.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>`).join('');
            bloodPressureLog.querySelectorAll('.delete-bp').forEach(b => b.addEventListener('click', (e) => handleDeleteBPReading(e.currentTarget.dataset.id)));
        }
        
        async function saveBPReading(e) {
            e.preventDefault(); if (!userId) { console.warn("Autenticaci√≥n requerida."); return; }
            showLoading("Guardando tensi√≥n...");
            const data = { date: bpDate.value, time: bpTime.value, systolic: parseInt(bpSystolic.value), diastolic: parseInt(bpDiastolic.value), pulse: bpPulse.value ? parseInt(bpPulse.value) : null, notes: bpNotes.value };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/bloodPressureReadings`), data);
                closeModal(bpModal); bpForm.reset();
            } catch (err) { console.error("Error guardando tensi√≥n:", err); } finally { hideLoading(); }
        }

        function handleDeleteBPReading(id) {
            openConfirmDeleteModal("¬øEliminar esta toma de tensi√≥n?", async () => {
                if(!userId) return; showLoading("Eliminando toma...");
                try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/bloodPressureReadings`, id));}
                catch (err) { console.error("Error eliminando toma:", err); } finally { hideLoading(); }
            });
        }

        function renderBPChart() { /* ... misma funci√≥n ... */
            if (bpChartInstance) bpChartInstance.destroy();
            if (!bloodPressureReadings || bloodPressureReadings.length < 2) {
                document.getElementById('bpChart').style.display = 'none';
                bpChartMessage.textContent = "Se necesitan al menos dos registros para mostrar la evoluci√≥n.";
                bpChartMessage.style.display = 'block'; return;
            }
            document.getElementById('bpChart').style.display = 'block';
            bpChartMessage.style.display = 'none';
            const labels = bloodPressureReadings.map(r => `${new Date(r.date+'T00:00').toLocaleDateString('es-ES',{month:'short',day:'numeric'})}${r.time?' '+r.time.substring(0,5):''}`);
            const systolic = bloodPressureReadings.map(r => r.systolic);
            const diastolic = bloodPressureReadings.map(r => r.diastolic);
            const pulse = bloodPressureReadings.map(r => r.pulse || null);
            bpChartInstance = new Chart(bpChartCanvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Sist√≥lica', data: systolic, borderColor: 'rgb(239,68,68)', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.1, yAxisID: 'yPressure', pointRadius:3, pointHoverRadius:5 },
                        { label: 'Diast√≥lica', data: diastolic, borderColor: 'rgb(59,130,246)', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.1, yAxisID: 'yPressure', pointRadius:3, pointHoverRadius:5 },
                        { label: 'Pulso', data: pulse, borderColor: 'rgb(16,185,129)', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.1, yAxisID: 'yPulse', pointRadius:2, pointHoverRadius:4, borderDash:[5,5], hidden: !pulse.some(p=>p!==null) }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { title: { display: true, text: 'Fecha y Hora' } },
                        yPressure: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Presi√≥n (mmHg)' }, suggestedMin: 50, suggestedMax: 180 },
                        yPulse: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Pulso (bpm)' }, suggestedMin: 40, suggestedMax: 120, grid: { drawOnChartArea: false }, display: pulse.some(p=>p!==null&&!isNaN(p)) }
                    },
                    plugins: { legend: { position: 'top' }, tooltip: { mode:'index', intersect:false, callbacks: { label: (c) => `${c.dataset.label||''}: ${c.parsed.y||''} ${c.dataset.yAxisID==='yPressure'?'mmHg':'bpm'}`}}}
                }
            });
        }

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', initializeAppAuth);
    </script>
</body>
</html>
